# æˆå‘˜2 - è®¤è¯ä¸å®‰å…¨ä¸“å®¶ äº¤ä»˜æ–‡æ¡£

## ğŸ“‹ èŒè´£æ¦‚è¿°

ä½œä¸ºè®¤è¯ä¸å®‰å…¨ä¸“å®¶ï¼Œè´Ÿè´£å®ç°ç”¨æˆ·è®¤è¯ä¸æƒé™ç®¡ç†ç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š
- ç”¨æˆ·æ³¨å†Œ/ç™»å½•åŠŸèƒ½
- å¯†ç åŠ å¯†ä¸Tokenç®¡ç†
- æƒé™æ§åˆ¶
- å®‰å…¨éªŒè¯å·¥å…·

---

## ğŸ“ äº¤ä»˜æ–‡ä»¶æ¸…å•

### 1. `src/auth.py` - ç”¨æˆ·è®¤è¯æ¨¡å—

**åŠŸèƒ½è¯´æ˜ï¼š**
- `UserAuth` ç±» - ç”¨æˆ·è®¤è¯æ ¸å¿ƒç±»
- å¯†ç å“ˆå¸Œä¸éªŒè¯ï¼ˆPBKDF2-SHA256ç®—æ³•ï¼‰
- ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€å¯†ç ç®¡ç†
- ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢ä¸æ›´æ–°

**ä¸»è¦æ–¹æ³•ï¼š**
| æ–¹æ³•å | åŠŸèƒ½ |
|--------|------|
| `hash_password()` | å¯†ç å“ˆå¸ŒåŠ å¯† |
| `verify_password()` | å¯†ç éªŒè¯ |
| `register_user()` | ç”¨æˆ·æ³¨å†Œ |
| `login_user()` | ç”¨æˆ·ç™»å½• |
| `login_with_token()` | ç™»å½•å¹¶è¿”å›Token |
| `get_user_by_id()` | æ ¹æ®IDè·å–ç”¨æˆ· |
| `get_user_by_email()` | æ ¹æ®é‚®ç®±è·å–ç”¨æˆ· |
| `get_user_by_username()` | æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ· |
| `update_password()` | æ›´æ–°å¯†ç  |
| `reset_password()` | é‡ç½®å¯†ç  |
| `deactivate_user()` | åœç”¨ç”¨æˆ· |
| `activate_user()` | æ¿€æ´»ç”¨æˆ· |
| `get_all_users()` | è·å–æ‰€æœ‰ç”¨æˆ· |
| `update_user_info()` | æ›´æ–°ç”¨æˆ·ä¿¡æ¯ |
| `check_user_exists()` | æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ |
| `validate_registration()` | éªŒè¯æ³¨å†Œä¿¡æ¯ |
| `get_current_user_from_token()` | ä»Tokenè·å–ç”¨æˆ· |
| `require_login` | ç™»å½•éªŒè¯è£…é¥°å™¨ |
| `get_current_user()` | è·å–å½“å‰ç™»å½•ç”¨æˆ· |

---

### 2. `src/security.py` - å®‰å…¨å·¥å…·æ¨¡å—

**åŠŸèƒ½è¯´æ˜ï¼š**
- JWT Tokenç®¡ç†ï¼ˆè®¿é—®ä»¤ç‰Œã€åˆ·æ–°ä»¤ç‰Œï¼‰
- å¯†ç é‡ç½®ä»¤ç‰Œ
- è¾“å…¥éªŒè¯ï¼ˆå¯†ç å¼ºåº¦ã€é‚®ç®±æ ¼å¼ã€ç”¨æˆ·åæ ¼å¼ï¼‰
- æƒé™æ§åˆ¶ç³»ç»Ÿ
- ä¼šè¯ç®¡ç†

**ä¸»è¦åŠŸèƒ½ï¼š**

#### Tokenç®¡ç†
| å‡½æ•°å | åŠŸèƒ½ |
|--------|------|
| `create_access_token()` | åˆ›å»ºJWTè®¿é—®ä»¤ç‰Œ |
| `create_refresh_token()` | åˆ›å»ºåˆ·æ–°ä»¤ç‰Œ |
| `verify_token()` | éªŒè¯JWTä»¤ç‰Œ |
| `get_user_id_from_token()` | ä»ä»¤ç‰Œè·å–ç”¨æˆ·ID |
| `refresh_access_token()` | åˆ·æ–°è®¿é—®ä»¤ç‰Œ |

#### å¯†ç é‡ç½®
| å‡½æ•°å | åŠŸèƒ½ |
|--------|------|
| `generate_password_reset_token()` | ç”Ÿæˆå¯†ç é‡ç½®ä»¤ç‰Œ |
| `verify_password_reset_token()` | éªŒè¯å¯†ç é‡ç½®ä»¤ç‰Œ |

#### è¾“å…¥éªŒè¯
| å‡½æ•°å | åŠŸèƒ½ |
|--------|------|
| `validate_password_strength()` | éªŒè¯å¯†ç å¼ºåº¦ |
| `validate_email()` | éªŒè¯é‚®ç®±æ ¼å¼ |
| `validate_username()` | éªŒè¯ç”¨æˆ·åæ ¼å¼ |

#### æƒé™æ§åˆ¶
| ç±»/å‡½æ•°å | åŠŸèƒ½ |
|-----------|------|
| `Permission` | æƒé™å¸¸é‡ç±» |
| `Role` | è§’è‰²å¸¸é‡ç±» |
| `ROLE_PERMISSIONS` | è§’è‰²æƒé™æ˜ å°„ |
| `check_permission()` | æ£€æŸ¥ç”¨æˆ·æƒé™ |
| `require_permission()` | æƒé™è£…é¥°å™¨ |

#### ä¼šè¯ç®¡ç†
| ç±»/æ–¹æ³• | åŠŸèƒ½ |
|---------|------|
| `SessionManager.create_session()` | åˆ›å»ºä¼šè¯ |
| `SessionManager.clear_session()` | æ¸…é™¤ä¼šè¯ |
| `SessionManager.is_session_valid()` | éªŒè¯ä¼šè¯æœ‰æ•ˆæ€§ |

#### å®‰å…¨å·¥å…·
| å‡½æ•°å | åŠŸèƒ½ |
|--------|------|
| `generate_secure_token()` | ç”Ÿæˆå®‰å…¨éšæœºä»¤ç‰Œ |
| `sanitize_input()` | æ¸…ç†ç”¨æˆ·è¾“å…¥ï¼ˆé˜²XSSï¼‰ |
| `mask_email()` | æ©ç é‚®ç®±åœ°å€ |

---

### 3. `pages/login.py` - ç™»å½•é¡µé¢

**åŠŸèƒ½è¯´æ˜ï¼š**
- Streamlitç™»å½•ç•Œé¢
- æ”¯æŒç”¨æˆ·åæˆ–é‚®ç®±ç™»å½•
- ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶
- å¯†ç é‡ç½®åŠŸèƒ½
- å·²ç™»å½•ç”¨æˆ·çŠ¶æ€æ˜¾ç¤º

**é¡µé¢åŠŸèƒ½ï¼š**
- ç™»å½•è¡¨å•ï¼ˆç”¨æˆ·å/é‚®ç®± + å¯†ç ï¼‰
- è®°ä½æˆ‘é€‰é¡¹
- å¿˜è®°å¯†ç æµç¨‹
- æ³¨å†Œé“¾æ¥è·³è½¬
- ç™»å½•å¸®åŠ©ä¿¡æ¯

---

### 4. `pages/register.py` - æ³¨å†Œé¡µé¢

**åŠŸèƒ½è¯´æ˜ï¼š**
- Streamlitæ³¨å†Œç•Œé¢
- å®æ—¶è¡¨å•éªŒè¯
- å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨
- ç”¨æˆ·åè®®ç¡®è®¤
- æ³¨å†ŒæˆåŠŸè‡ªåŠ¨ç™»å½•

**é¡µé¢åŠŸèƒ½ï¼š**
- æ³¨å†Œè¡¨å•ï¼ˆç”¨æˆ·å + é‚®ç®± + å¯†ç  + ç¡®è®¤å¯†ç ï¼‰
- å¯†ç å¼ºåº¦å¯è§†åŒ–
- è¾“å…¥éªŒè¯æç¤º
- ç”¨æˆ·åè®®å±•ç¤º
- æ³¨å†Œé¡»çŸ¥

---

### 5. `src/api_routes/auth_routes.py` - è®¤è¯APIè·¯ç”±

**APIç«¯ç‚¹ï¼š**

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | è®¤è¯ |
|------|------|------|------|
| POST | `/auth/register` | ç”¨æˆ·æ³¨å†Œ | å¦ |
| POST | `/auth/login` | ç”¨æˆ·ç™»å½• | å¦ |
| POST | `/auth/refresh` | åˆ·æ–°Token | å¦ |
| GET | `/auth/me` | è·å–å½“å‰ç”¨æˆ· | æ˜¯ |
| PUT | `/auth/me` | æ›´æ–°ç”¨æˆ·ä¿¡æ¯ | æ˜¯ |
| POST | `/auth/password/update` | æ›´æ–°å¯†ç  | æ˜¯ |
| POST | `/auth/password/reset-request` | è¯·æ±‚å¯†ç é‡ç½® | å¦ |
| POST | `/auth/password/reset-confirm` | ç¡®è®¤å¯†ç é‡ç½® | å¦ |
| POST | `/auth/logout` | ç”¨æˆ·ç™»å‡º | æ˜¯ |
| GET | `/auth/verify` | éªŒè¯Token | æ˜¯ |
| GET | `/auth/check-username/{username}` | æ£€æŸ¥ç”¨æˆ·åå¯ç”¨æ€§ | å¦ |
| GET | `/auth/check-email/{email}` | æ£€æŸ¥é‚®ç®±å¯ç”¨æ€§ | å¦ |

---

### 6. `tests/test_auth.py` - è®¤è¯æµ‹è¯•

**æµ‹è¯•è¦†ç›–ï¼š**
- ç”¨æˆ·æ³¨å†Œæµ‹è¯•
- ç”¨æˆ·ç™»å½•æµ‹è¯•
- å¯†ç æ“ä½œæµ‹è¯•
- Tokenæ“ä½œæµ‹è¯•
- éªŒè¯åŠŸèƒ½æµ‹è¯•
- å¯†ç é‡ç½®æµ‹è¯•
- ä¼šè¯ç®¡ç†æµ‹è¯•
- ç”¨æˆ·ç®¡ç†æµ‹è¯•

---

## ğŸ” å®‰å…¨ç‰¹æ€§

### å¯†ç å®‰å…¨
- **å“ˆå¸Œç®—æ³•**: PBKDF2-HMAC-SHA256
- **è¿­ä»£æ¬¡æ•°**: 100,000æ¬¡
- **ç›å€¼**: éšæœºç”Ÿæˆ16å­—èŠ‚
- **å¯†ç è¦æ±‚**: 
  - æœ€å°‘8ä¸ªå­—ç¬¦
  - å¿…é¡»åŒ…å«å­—æ¯
  - å¿…é¡»åŒ…å«æ•°å­—

### Tokenå®‰å…¨
- **ç®—æ³•**: HS256 (HMAC-SHA256)
- **è®¿é—®ä»¤ç‰Œæœ‰æ•ˆæœŸ**: 24å°æ—¶
- **åˆ·æ–°ä»¤ç‰Œæœ‰æ•ˆæœŸ**: 7å¤©
- **å¯†ç é‡ç½®ä»¤ç‰Œæœ‰æ•ˆæœŸ**: 30åˆ†é’Ÿ
- **å”¯ä¸€æ ‡è¯†ç¬¦(JTI)**: ç”¨äºä»¤ç‰Œæ’¤é”€

### æƒé™ç³»ç»Ÿ
- **è§’è‰²**: USER, AUDITOR, ADMIN
- **æƒé™**: READ, WRITE, DELETE, ADMIN
- åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶(RBAC)

---

## ğŸ“– ä½¿ç”¨ç¤ºä¾‹

### ç”¨æˆ·æ³¨å†Œ
```python
from src.auth import UserAuth, AuthenticationError

try:
    user = UserAuth.register_user(
        username="newuser",
        email="user@example.com",
        password="SecurePass123"
    )
    print(f"æ³¨å†ŒæˆåŠŸ: {user.username}")
except AuthenticationError as e:
    print(f"æ³¨å†Œå¤±è´¥: {e}")
```

### ç”¨æˆ·ç™»å½•
```python
from src.auth import UserAuth

try:
    user = UserAuth.login_user("newuser", "SecurePass123")
    print(f"æ¬¢è¿, {user.username}!")
except AuthenticationError as e:
    print(f"ç™»å½•å¤±è´¥: {e}")
```

### Tokenä½¿ç”¨
```python
from src.security import create_access_token, verify_token

# åˆ›å»ºToken
token = create_access_token(user_id=1, username="testuser")

# éªŒè¯Token
payload = verify_token(token)
if payload:
    print(f"ç”¨æˆ·ID: {payload['user_id']}")
```

### å¯†ç éªŒè¯
```python
from src.security import validate_password_strength

is_valid, message = validate_password_strength("MyPass123")
if is_valid:
    print("å¯†ç å¼ºåº¦åˆæ ¼")
else:
    print(f"å¯†ç ä¸åˆæ ¼: {message}")
```

---

## ğŸ”§ é…ç½®è¯´æ˜

åœ¨ `config.py` ä¸­çš„ç›¸å…³é…ç½®ï¼š

```python
# JWTé…ç½®
JWT_SECRET_KEY = os.getenv("JWT_SECRET_KEY", SECRET_KEY)
JWT_ALGORITHM = "HS256"
JWT_EXPIRATION_HOURS = 24

# Sessioné…ç½®
SECRET_KEY = os.getenv("SECRET_KEY", "your-secret-key-change-in-production")
SESSION_TIMEOUT = 3600  # 1å°æ—¶
```

**é‡è¦**: ç”Ÿäº§ç¯å¢ƒè¯·åŠ¡å¿…è®¾ç½®å¼ºå¯†é’¥ï¼

---

## âœ… å®ŒæˆçŠ¶æ€

| åŠŸèƒ½æ¨¡å— | çŠ¶æ€ |
|----------|------|
| å¯†ç åŠ å¯† | âœ… å®Œæˆ |
| ç”¨æˆ·æ³¨å†Œ | âœ… å®Œæˆ |
| ç”¨æˆ·ç™»å½• | âœ… å®Œæˆ |
| JWT Tokenç®¡ç† | âœ… å®Œæˆ |
| åˆ·æ–°ä»¤ç‰Œ | âœ… å®Œæˆ |
| å¯†ç é‡ç½® | âœ… å®Œæˆ |
| è¾“å…¥éªŒè¯ | âœ… å®Œæˆ |
| æƒé™æ§åˆ¶ | âœ… å®Œæˆ |
| ä¼šè¯ç®¡ç† | âœ… å®Œæˆ |
| ç™»å½•é¡µé¢ | âœ… å®Œæˆ |
| æ³¨å†Œé¡µé¢ | âœ… å®Œæˆ |
| APIè·¯ç”± | âœ… å®Œæˆ |
| å•å…ƒæµ‹è¯• | âœ… å®Œæˆ |

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç”Ÿäº§ç¯å¢ƒ**: åŠ¡å¿…æ›´æ”¹é»˜è®¤å¯†é’¥
2. **HTTPS**: ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨HTTPS
3. **é€Ÿç‡é™åˆ¶**: å»ºè®®æ·»åŠ Rediså®ç°å®Œæ•´çš„é€Ÿç‡é™åˆ¶
4. **é‚®ä»¶æœåŠ¡**: å¯†ç é‡ç½®åŠŸèƒ½éœ€è¦é…ç½®é‚®ä»¶æœåŠ¡
5. **Tokené»‘åå•**: å¦‚éœ€å®ç°ç™»å‡ºä½¿Tokenå¤±æ•ˆï¼Œéœ€è¦Redisæ”¯æŒ

---

**äº¤ä»˜æ—¥æœŸ**: 2026å¹´1æœˆ24æ—¥  
**æˆå‘˜2 - è®¤è¯ä¸å®‰å…¨ä¸“å®¶**
